{% extends "base/base.html" %}
{% load static %}
{% block title %}Crawl {{ crawl.name }}{% endblock %}

{% block extrahead %}
  <link href="{% static 'base/css/bokeh.min.css' %}" rel="stylesheet">
{% endblock %}

{% block extrafooter %}
    <script src="{% static 'base/js/bootstrap.min.js' %}"></script>
    <script src="{% static 'base/js/bokeh.min.js' %}"></script>
    <script src="{% static 'base/js/ajax.js' %}"></script>
    <script src="{% static 'base/js/crawl_statuses.js' %}"></script>
    <script src="{% static 'base/js/crawl.js' %}"></script>
{% endblock %}

{% block content %}
{% if scripts %}
    {% for script in scripts %}
        {{ script | safe }}
    {% endfor %}
{% endif %}

{% include "base/sidebar.html" %}

  <!-- Crawl Header -->
<div class='row'>
  <div class="col-md-offset-2 col-md-10">
          <ol class="breadcrumb">
            <li> <a href="/"> / My Projects / </a></li> <a href="{% url 'base:project' project_slug=project.slug %}" style="text-decoration:none;">{{ project.name }} </a> / {{ crawl.name }}
          </ol>
  </div>
  <div class=" col-md-offset-2 col-md-8">

  <!-- Crawl Title -->
  <h1>{{ crawl.name }} <small>({{ crawl.crawler }})</small>

    <!-- Crawl Settings -->
    <div class="pull-right">
    <a href="{% url 'base:crawl_space:crawl_settings' project_slug=project.slug crawl_slug=crawl.slug %}">
      <i class="fa fa-pencil " style="font-size:20px; padding-right:7px;"></i></a>
      <a href="#">
      <form style="display:inline"
            action="{% url 'base:crawl_space:delete_crawl' project_slug=project.slug crawl_slug=crawl.slug %}"
            method="post" onSubmit="return confirm('Are you sure you want to delete this crawl?')">
            {% csrf_token %}
        <button
            class="fa fa-trash no-style-btn" style="font-size:20px;" type="submit">
        </button>
        </form>

      </a>
      </div>
    </h1>
    <hr/>


  <!-- Crawl Status -->


  </div>
</div>


<!-- Buttons -->
<div class='row'>
  <div class='col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 controls'>
    <!-- Crawl actions (Start, Stop[, Restart]) -->
    <div class='row'>

      <div class="col-md-3" style="margin-top:1%">
        <button id="playButton" title="Start Crawl" type="button" class="btn btn-control"
          data-container="body"
          {% if crawl.status != "NOT STARTED" %}
              disabled
          {% endif %}
          data-toggle="tooltip" data-placement="bottom">
          <span class="fa fa-play fa-2x"></span>
        </button>

        <button id="stopButton" title="Stop Crawl" type="button" class="btn btn-control"
          data-container="body"
          {% if crawl.status != "running" %}
          disabled
          {% endif %}
          data-toggle="tooltip" data-placement="bottom">
          <span class="fa fa-stop fa-2x"></span>
        </button>

        <button id="restartButton" title="Restart Crawl" type="button" class="btn btn-control"
          data-container="body"
          {% if crawl.status != "stopped" %}
            disabled
          {% endif %}
          data-toggle="tooltip" data-placement="bottom">
          <span class="fa fa-refresh fa-2x"></span>
        </button>
      {% if crawl.crawler == "nutch" %}
      <button id="forceStopButton" title="Force Stop Crawl" type="button" class="btn btn-control"
        data-container="body"
        {% if crawl.status != "STARTED" %}
          disabled
        {% endif %}
        data-toggle="tooltip" data-placement="bottom">
        <span class="fa fa-exclamation-triangle fa-2x"></span>
      </button>
      {% endif %}
      </div>

      <div class="col-md-3">
        <h5>Crawl Status: 
          <span>
            <div class="progress">
              <div  id="status" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%" class="progress-bar 
              {% if crawl.status == "NOT STARTED" %}
                progress-bar-warning
              {% elif crawl.status == "SUCCESS" %}
                progress-bar-success
              {% elif crawl.status == "DANGER" %}
                progress-bar-danger
              {% else %}
                progress-bar-info progress-bar-striped active
              {% endif %}
                ">
                  {{ crawl.status }}
              </div>
            </div>
          </span>
        </h5>
        {% if crawl.crawler == "nutch" %}
        <h5>Rounds left: <span id="roundsLeft">{{ crawl.rounds_left }}</span>/
        <input id="rounds" type="number" class="input-xs" value="{{ crawl.rounds_left }}" min="1" max="99"/></h5>
        {% endif %}
      </div>
      
      <div class="col-md-4 btn-group" style="margin-top:1%;">
        <form method="get" style="display:inline;">
            <input type="hidden" name="resource" value="initial_seeds">
            <button title="Get Seeds List" id="getInitialSeeds" class="btn btn-default btn-duo center link-button"
            data-container="body" data-toggle="tooltip" data-placement="bottom"
            style="height:40px;width:auto;display:inline;">
            Get Seeds List
            </button>
        </form>
        <form method="get" style="display:inline;">
            <input type="hidden" name="resource" value="crawl_log">
            <button title="Get Crawl Log" id="getCrawlLog" class="btn btn-default btn-duo center link-button"
            {% if crawl.status == "Not started" %}
            disabled
            {% endif %}
            data-container="body" data-toggle="tooltip" data-placement="bottom"
            style="height:40px;width:auto;display:inline;">
            Get Crawl Log
            </button>
        </form>
      </div>
    </div>

    <!--
    <div class="row">
      {% if crawl.crawler == "nutch" %}
        <button id="common-crawl-dump" title="Dump (CCA format)" type="button" class="btn btn-control"
            data-container="body" data-toggle="tooltip" data-placement="bottom"
            style="height:40px;width:auto;display:inline;">
           Dump (CCA format)
        </button>
      {% endif %}
    </div>
    -->
    <div class="col-sm-3" style="padding-left:0px;display:inline;">

    </div>
  </div>
</div>
{% if crawl.crawler == "ache" %}
<div class='row'>
  <div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
    {% if divs.0 or divs.1 %}

        {% for div in divs %}
        {% if div %}
        <div class='col-sm-5'>
            {{ div | safe }}
        </div>
        {% endif %}
        {% endfor %}
    {% elif crawl.crawler == 'ache' %}
        <div class='col-sm-6'>
            <h2>Waiting for plots...</h2>
        </div>
    {% endif %}
  </div>
</div>

<div class='row'>
  <div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
    <form method="get">
    <input type="hidden" name="resource" value="seeds" />
      <button id="getSeeds" class="btn btn-default btn-padded center"
        data-container="body" data-toggle="tooltip" data-placement="bottom"
        {% if not divs.0 or not divs.1 %}
          disabled
        {% endif %}
        >
          Download Relevant Pages
        </button>
      </form>
  </div>
</div>
{% endif %}

<!--
{% if crawl.crawler == "nutch" %}
<div class='row'>
    <div id="nutchButtons" class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
        <br>

        <button id="gotoSolr" type="button" title="Goto Solr" class="btn btn-default btn-duo center">
            <a>View Results in Solr</a>
        </button>
        <button id="dumpImages" type="button" title="Dump crawled images" class="btn btn-default btn-duo center">
            <a>Dump Images</a>
        </button>
        <a id="gotoKibana"
            style="float:left;" class="btn btn-default btn-duo center link-button" href="{{ kibana }}">
            Kibana
        </a>
    </div>
</div>
{% endif %}
-->

{% if crawl.description or crawl.crawler == "ache" %}
<div class='row'>
  <div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
    {% if crawl.description %}
    <div class="col-sm-6">
        <h3>Description</h3>
        <p>{{ crawl.description }}</p>
    </div>
    {% endif %}
    {% if crawl.crawler == 'ache' %}
    <div class="col-sm-6">
        <h3>Crawl Model</h3>
        <p> {{ crawl.crawl_model }}</p>
    </div>
    {% endif %}
  </div>
</div>
{% endif %}

<div class='row'>
  <div class="col-md-8 col-md-offset-2 main">
    <div class="row">
      <hr/>
        <h4 class="col-md-3">
            Summary Statistics
        </h4>
        <div class="col-md-2 pull-right">
          <a id="gotoKibana"
            class="btn btn-default btn-duo center link-button" target="_blank" href="{{ kibana }}">
            Visualize
              </a>
        </div>
    <!--   <div class='row'>
      <div class="col-sm-12 col-md-5">
     --> <table data-toggle="table" class="table col-md-12">
        <thead>
          <tr>
        {% if crawl.crawler == "ache" %}
            <th>Pages Crawled</th>
            <th>Harvest Rate</th>
        {% else %}
            <th>Pages Crawled</th>
        {% endif %}
          </tr>
        </thead>
        <tbody>
          <tr>
        {% if crawl.crawler == "ache" %}
            <td><span id="stats-pages">{{ crawl.pages_crawled }}</span></td>
            <td><span id="stats-harvest">{{ crawl.harvest_rate }}</span></td>
        {% else %}
            <td><span id="stats-pages">{{ crawl.pages_crawled }}</span></td>
        {% endif %}
          </tr>
        </tbody>
      </table>
    </div>
<!--   </div>
  </div>
 -->  </div>
</div>

{% if crawl.crawler == "nutch" %}
<!-- <div class='row'>
    <div class="col-sm-7 col-sm-offset-3 col-md-7 col-md-offset-2 main">
        <div role="tabpanel">
            <ul class="nav nav-tabs" role="tablist">
                <li role="presentation" class="active"><a href="#logio" aria-controls="logio" role="tab" data-toggle="tab">log.io</a></li>
                <li role="presentation"><a href="#kibana" aria-controls="kibana" role="tab" data-toggle="tab">Kibana</a></li>
            </ul>
        </div>
        <div class="tab-content">
            <div role="tabpanel" class="tab-pane active" id="logio">
                <iframe src="{{ logio }}" style="width:100%;height:600px;border:1px solid #EEEEEE;"></iframe>
            </div>
            <div role="tabpanel" class="tab-pane" id="kibana">
                <iframe src="{{ kibana }}" style="width:100%;height:600px;border:1px solid #EEEEEE;"></iframe>
            </div>
        </div>
    </div>
</div> -->
<div class='row'>
    <div class="col-sm-7 col-sm-offset-3 col-md-7 col-md-offset-2 main">
        <iframe src="{{ logio }}" style="width:100%;height:600px;border:1px solid #EEEEEE;"></iframe>
    </div>
</div>
{% endif %}

{% endblock content %}
